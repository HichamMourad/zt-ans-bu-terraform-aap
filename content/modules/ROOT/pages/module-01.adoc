= Terraform & Red Hat Ansible Automation Platform 2.5 Lab Guide
:doctype: book
:toc: left
:toclevels: 1
:sectanchors:
:sectlinks:
:sectnums:
:source-highlighter: highlight.js


== Overview

Terraform is a powerful tool for deploying cloud infrastructure using Infrastructure as Code (IaC). It allows us to define infrastructure and then build, change, and destroy these resources systematically.

While Terraform is excellent for infrastructure deployment, adding Ansible to the mix brings Configuration as Code (CaC) to the party, adding significant value to your automation journey!

[.text-center]
image:https://github.com/HichamMourad/terraform-aap/blob/main/images/main.png?raw=true[Terraform and Ansible Integration,800,align="center",style="border: 2px solid black"]

[.lab-info]
--
*Estimated time to complete:* 45 minutes
--

== Lab Objectives

Welcome to the `Terraform and Ansible Automation Platform` lab. In the following challenges and tasks, we will guide you through using Ansible Automation Platform and Terraform together to trigger Terraform infrastructure creation from a central automation tool (Ansible Automation Platform).

By the end of this lab, you will learn:

* How to configure the Terraform Backend Credential in Ansible Automation Platform
* How to configure the Terraform Inventory
* How to create Ansible job templates and run them to create AWS resources using Terraform
* How to integrate Terraform with Ansible Automation Platform for seamless infrastructure management

'''

== Task 1: Configure the Terraform Backend Credential in Ansible Automation Platform

=== Understanding the Terraform Backend Credential Type

The `Terraform Backend Credential Type` enables secure storage of configuration for any remote Terraform backend in Ansible Automation Platform. This allows Ansible Automation Platform to access the Terraform State File wherever you choose to store it.

In this lab, you will store the Terraform State File on an AWS S3 storage bucket.

=== Step 1: Login to AWS and Retrieve the S3 Bucket Name

Before configuring the `Terraform Backend Credential` in Ansible Automation Platform, we need to identify the S3 bucket name where the Terraform state files will be stored.

**1.** Click on the `AWS Console` tab at the top of the lab.

**2.** Note your temporary AWS account details (you'll need these now and later).

[.text-center]
image::https://github.com/HichamMourad/terraform-aap/blob/main/images/awsconsole.png?raw=true[AWS Console Tab,800,align="center",style="border: 2px solid black"]

**3.** Launch the AWS console from the `Account ID` launch link.

**4.** Login with the provided AWS credentials.

[.text-center]
image::https://github.com/HichamMourad/terraform-aap/blob/main/images/awslogin.png?raw=true[AWS Login,800,align="center",style="border: 2px solid black"]

**5.** Upon login to AWS, type `S3` in the search field and select the S3 service.

**6.** In the S3 service, you will see the existing S3 storage bucket that we've already created for you.

**7.** Make note of the bucket name - it will start with `aap-tf-bucket-###aLongListofCharacters###`.

[TIP]
====
We will need this bucket name shortly for the backend configuration.
====

[.text-center]
image:https://github.com/HichamMourad/terraform-aap/blob/main/images/awss3name.png?raw=true[S3 Bucket Name,800,align="center",style="border: 2px solid black"]

=== Step 2: Create the Terraform Backend Credential in Ansible Automation Platform

**1.** Click on the `Ansible Automation Platform` tab at the top of the lab.

**2.** Log in using the following credentials:
   * *Username:* `admin`
   * *Password:* `ansible123!`

[NOTE]
====
Credentials are utilized for authentication when launching jobs against machines, synchronizing with inventory sources, and importing project content from version control systems.

In this lab, we have created several different credentials:

* `AWS_Credential` - AWS credential for performing actions on AWS cloud (creating VPCs, instances, etc.)
* `SSH Controller Credentials` - SSH key for the Ansible Automation Platform
====

**3.** Navigate to credentials by expanding the `Automation Execution` menu on the left.

**4.** Go to `Automation Execution` â†’ `Infrastructure` â†’ `Credentials`.

**5.** Click on the `Credentials` link and examine the pre-configured credentials.

[IMPORTANT]
====
The keys are encrypted, so no one (not even administrators) can see the keys once placed in Ansible Automation Platform as a credential.
====

**6.** Click on `+ Create credential`.

**7.** Configure the credential with the following details:
   * *Name:* `Terraform Backend Credential`
   * *Credential Type:* `Terraform backend configuration` (from dropdown)

**8.** In the `Backend configuration` section, enter the following details (you MUST update lines 1, 2, 4, and 5 with your specific details):

[source,hcl]
----
bucket = "aap-tf-bucket-ALONG-LISTOF-CHARACTERS-CHANGE-ME"
key = "YOURNAME/tfstatefile"
region = "us-east-1"
access_key = "YOUR-LAB-awsaccesskey-CHANGE-ME"
secret_key = "YOUR-LAB-awssecretkey-CHANGE-ME"
----

[.text-center]
image::https://github.com/HichamMourad/terraform-aap/blob/main/images/tfbackendcred.png?raw=true[Terraform Backend Credential,800,align="center",style="border: 2px solid black"]

[WARNING]
====
Before clicking `Create credential`, ensure your configuration looks SIMILAR to the following example BUT WITH YOUR SPECIFIC AWS ENVIRONMENT DETAILS:

[source,hcl]
----
bucket = "aap-tf-bucket-cfe5d5cb-b3fa-5555-555c-blahblahblah"
key = "johnsmith/tfstatefile"
region = "us-east-1"
access_key = "AKBCDEBLAHBLAHBLAH"
secret_key = "Oz8vqJsY6zFFFq83xblahblahblahblahblah"
----
====

**9.** Click on `Create credential` to save the credential.

'''

== Task 2: Configure Terraform Inventory

=== Understanding Terraform Inventory in Ansible Automation Platform

An Inventory is a collection of hosts against which automation jobs may be launched. You can source your inventory data from external sources and cloud providers. In this case, we will be sourcing our data from Terraform, which is why we'll create a Terraform Inventory Source.

=== Step 1: Create the Terraform Inventory Source

**1.** Click on the `Ansible Automation Platform` tab at the top of the lab (if not already there).

**2.** Navigate to inventories by expanding the `Automation Execution` menu on the left.

**3.** Go to `Automation Execution` â†’ `Infrastructure` â†’ `Inventories`.

**4.** Notice the inventory we've created for you called `Terraform Inventory`.

[.text-center]
image:https://github.com/HichamMourad/terraform-aap/blob/main/images/tfinventory1.png?raw=true[Terraform Inventory,800,align="center",style="border: 2px solid black"]

**5.** Click on this inventory, then select the `Sources` tab.

**6.** Click the `+ Create Source` button and enter the following details:

[cols="1,2"]
|===
| Field | Value

| Name
| Terraform Source

| Execution environment
| Terraform Execution Environment

| Source
| Terraform State

| Credential
| Terraform Backend Credential

| Verbosity
| 0 (Warning)

| Overwrite
| âœ“ Check this box

| Update on launch
| âœ“ Check this box

| Cache timeout (seconds)
| 0

| Source variables
| backend_type: s3
|===

**7.** Click on `Create source` to save this new Inventory Source.

**8.** Select the `Launch inventory update` button at the top to test the Terraform inventory source and the credential you created.

[.text-center]
image:https://github.com/HichamMourad/terraform-aap/blob/main/images/tfinventorysource1.png?raw=true[Terraform Inventory Source,800,align="center",style="border: 2px solid black"]

**9.** Click the `Launch inventory update` button to validate the correct configuration of this inventory source.

**10.** Wait for the Status to show `Success`.

[.text-center]
image:https://github.com/HichamMourad/terraform-aap/blob/main/images/tfinventorysource2.png?raw=true[Inventory Update Success,800,align="center",style="border: 2px solid black"]

[NOTE]
====
If the inventory update doesn't succeed, please re-check and update the Terraform Backend Credential configuration.
====

'''

== Task 3: Create a Job Template for Terraform AWS Provider

In this task, we will create an Ansible Job Template that will kick off a Terraform project. The Terraform project will leverage the AWS provider to create an EC2 instance in your AWS cloud account.

[NOTE]
====
Please note that you can also perform this same process with Azure and Google Cloud providers.
====

=== Step 1: Create and Launch the Job Template

**1.** Click on the `Ansible Automation Platform` tab at the top of the lab (if not already there).

**2.** Navigate to templates by expanding the `Automation Execution` menu on the left.

**3.** Go to `Automation Execution` â†’ `Templates`.

**4.** Click on `+ Create Template`.

[.text-center]
image::https://github.com/HichamMourad/terraform-aap/blob/main/images/create_templates1st.png?raw=true[Create Template,800,align="center",style="border: 2px solid black"]

**5.** Fill out the following fields:

[cols="1,2"]
|===
| Field | Value

| Name
| Deploy AWS resources using Terraform AWS provider

| Inventory
| Terraform Inventory

| Project
| Terraform Demos Project

| Playbook
| playbooks/1deploy-terraform-aws-provider.yml

| Execution environment
| Terraform Execution Environment

| Credentials
| "AWS_Credential" AND "Terraform Backend Credential"
|===

**6.** Scroll to the bottom and click the blue `Create Job Template` button to save the job template.

[.text-center]
+++<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/create_templates2.png?raw=true" style="width:800px;margin-left:0px;border: 2px solid black">+++

**7.** Launch the `Deploy AWS resources using Terraform AWS provider` job template by selecting it and clicking on `ðŸš€ Launch template`, or by clicking the `Rocket Launcher` ðŸš€ icon.

**8.** The job status will show `Running` momentarily.

**9.** Observe the output of the Job Template run.

[.text-center]
+++<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/jtresult1.png?raw=true" style="width:800px;margin-left:0px;border: 2px solid black">+++

=== Step 2: Manually Synchronize the Terraform Inventory Source

**1.** Return to the `Inventories` menu in Ansible Automation Platform.

**2.** Select the `Terraform Inventory`, then click on the `Hosts` menu.

**3.** Notice that there is NO Terraform inventory available yet.

[.text-center]
+++<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/tfinventoryhosts1.png?raw=true" style="width:800px;margin-left:0px;border: 2px solid black">+++

**4.** Click on the `Sources` menu and click on the `ðŸš€ Launch Inventory Update` icon.

[.text-center]
+++<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/tfinventorysource3.png?raw=true" style="width:800px;margin-left:0px;border: 2px solid black">+++

**5.** Return to the `Hosts` menu and notice that you now have an EC2 instance created by Terraform as part of your inventory.

[.text-center]
+++<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/tfinventoryhosts2.png?raw=true" style="width:800px;margin-left:0px;border: 2px solid black">+++

[NOTE]
====
The inventory updates can occur automatically, but we performed this manually so you could see the before and after results in the `Hosts` tab of the `Terraform Inventory`.
====

=== Task 3 Summary

In this task, you created an AAP Job Template that kicks off a Terraform Project. The Terraform Project uses the Terraform Provider for AWS to trigger the creation of AWS resources. You then synchronized the inventory source that pulled in the inventory created by Terraform. This demonstrates an excellent way to trigger Terraform Projects from Ansible Automation Platform - **A BETTER TOGETHER STORY!**

=== The Terraform Project Configuration

Here's the Terraform main.tf project file that was launched using Ansible Automation Platform:

[source,hcl]
----
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "6.2.0"
    }
  }
  backend "s3" {}
}

provider "aws" {
  region = "us-east-1"
}

# Fetch the default VPC
data "aws_vpc" "default" {
  default = true
}

resource "aws_instance" "tf-demo-aws-ec2-instance-1" {
  ami           = "ami-0005e0cfe09cc9050"
  instance_type = "t2.micro"
  tags = {
    Name = "tf-demo-aws-ec2-instance-1"
  }
}
----

'''

== Task 4: Create a Job Template for Terraform AWS & AAP Providers

In this task, we will create an Ansible Job Template that kicks off a Terraform project using both AWS and Ansible Automation Platform providers. **The Terraform project will create AWS resources and leverage the Ansible Automation Platform provider to push the Terraform inventory (EC2 hosts) directly into the Ansible Automation Platform inventory.**

[NOTE]
====
Please note that you can also perform this with Azure and Google Cloud providers in the same way as demonstrated here with AWS.
====

=== Step 1: Create and Launch the Job Template

**1.** Click on the `Ansible Automation Platform` tab at the top of the lab (if not already there).

**2.** Navigate to templates by expanding the `Automation Execution` menu on the left.

**3.** Go to `Automation Execution` â†’ `Templates`.

**4.** Click on `+ Create Template`, then scroll down and click `Create job template`.

[.text-center]
+++<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/create_templates.png?raw=true" style="width:800px;margin-left:0px;border: 2px solid black">+++

**5.** Fill out the following fields:

[cols="1,2"]
|===
| Field | Value

| Name
| Deploy AWS resources using Terraform AWS & ANSIBLE-AAP provider

| Inventory
| Terraform Inventory

| Project
| Terraform Demos Project

| Playbook
| playbooks/2deploy-terraform-ansible-provider.yml

| Execution environment
| Terraform Execution Environment

| Credentials
| "AWS_Credential" AND "Terraform Backend Credential"
|===

**6.** Scroll to the bottom and click the blue `Create Job Template` button to save the job template.

**7.** Launch the `Deploy AWS resources using Terraform AWS & ANSIBLE-AAP provider` job template by selecting it and clicking on `ðŸš€ Launch template`, or by clicking the `Rocket Launcher` ðŸš€ icon.

**8.** The job status will show `Running` momentarily.

**9.** Observe the output of the Job Template run.

=== Step 2: View the Terraform Inventory

**1.** Return to the `Inventories` menu in Ansible Automation Platform.

**2.** Select the `Terraform Inventory`, then click on the `Hosts` menu.

**3.** Notice that you now have an additional EC2 instance created by Terraform as part of your inventory.

[TIP]
====
**The Terraform Provider for Ansible Automation Platform automatically pushed the EC2 hosts created into the Ansible Automation Platform inventory.**
====

[.text-center]
+++<img src="https://github.com/HichamMourad/terraform-aap/blob/main/images/tfinventoryhosts3.png?raw=true" style="width:800px;margin-left:0px;border: 2px solid black">+++

=== Task 4 Summary

In this task, you created an AAP Job Template that kicks off a Terraform Project using the Terraform Provider for Ansible Automation Platform to create AWS resources. Terraform (via the Terraform Provider for AAP) then automatically pushed the created resources into the Ansible Automation Platform Inventory.

The Terraform Provider for AAP is typically used at the Terraform command line by Terraform users. Here you saw how to use it within Ansible Automation Platform. The Terraform Provider for Ansible Automation Platform can also trigger Ansible Automation Platform Job Templates, further enhancing the **BETTER TOGETHER STORY** and providing more options and choices for automators and infrastructure operators!

=== The Terraform Project Configuration

Here's the Terraform main.tf project file that was launched using Ansible Automation Platform:

[source,hcl]
----
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "6.2.0"
    }

    aap = {
      source = "ansible/aap"
    }
  }
  backend "s3" {}
}

provider "aws" {
  region = "us-east-1"
}

resource "aws_instance" "tf-demo-aws-ec2-instance-2" {
  ami           = "ami-0005e0cfe09cc9050"
  instance_type = "t2.micro"
  tags = {
    Name = "tf-demo-aws-ec2-instance-2"
  }
}

provider "aap" {
  host     = "https://controller"
  username = "admin"
  password = "ansible123!"
  insecure_skip_verify = true
}

resource "aap_host" "tf-demo-aws-ec2-instance-2" {
  inventory_id = 2
  name = "aws_instance_tf-demo-aws-ec2-instance-2"
  description = "An EC2 instance created by Terraform"
  variables = jsonencode(aws_instance.tf-demo-aws-ec2-instance-2)
}
----

'''

== Next Steps

Congratulations! You have successfully completed the Terraform and Ansible Automation Platform integration lab. You have learned how to:

âœ… Configure Terraform Backend Credentials in Ansible Automation Platform
âœ… Set up Terraform Inventory sources
âœ… Create and execute job templates that trigger Terraform projects
âœ… Integrate AWS resources with Ansible Automation Platform using Terraform providers
